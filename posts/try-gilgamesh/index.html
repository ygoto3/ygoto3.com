<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="description" content="Software engineer at CyberAgent."><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Gilgamesh を使って UI コンポーネントを拡張してみる | ygoto3.com</title><meta name="description" content="UI をコンポーネント・ベースで開発していると、コンポーネントを開発した当初は予期していなかったカスタマイズが必要になることがあります。何でもカスタマイズできるような汎用性を持たせられれば、それが一番良いですが、過剰な汎用性はアプリケーションを不必要に重くするだけです。 しかし、アプリケーション固有の UI コンポーネントをある程度の大きさの粒度で作っている場合、必要十分な汎用性を予測することは非">
<meta name="keywords" content="AngularJS">
<meta property="og:type" content="article">
<meta property="og:title" content="Gilgamesh を使って UI コンポーネントを拡張してみる">
<meta property="og:url" content="https://ygoto3.com/posts/try-gilgamesh/index.html">
<meta property="og:site_name" content="ygoto3.com">
<meta property="og:description" content="UI をコンポーネント・ベースで開発していると、コンポーネントを開発した当初は予期していなかったカスタマイズが必要になることがあります。何でもカスタマイズできるような汎用性を持たせられれば、それが一番良いですが、過剰な汎用性はアプリケーションを不必要に重くするだけです。 しかし、アプリケーション固有の UI コンポーネントをある程度の大きさの粒度で作っている場合、必要十分な汎用性を予測することは非">
<meta property="og:image" content="https://ygoto3.com/images/try-gilgamesh/postForm.png">
<meta property="og:image" content="https://ygoto3.com/images/try-gilgamesh/SampleLabel.png">
<meta property="og:image" content="https://ygoto3.com/images/try-gilgamesh/postForm.png">
<meta property="og:image" content="https://ygoto3.com/images/try-gilgamesh/postFormPartial.png">
<meta property="og:image" content="https://ygoto3.com/images/try-gilgamesh/postFormExclude.png">
<meta property="og:image" content="https://ygoto3.com/images/try-gilgamesh/postFormImport.png">
<meta property="og:image" content="https://ygoto3.com/images/try-gilgamesh/postFormExtend.png">
<meta property="og:updated_time" content="2019-02-13T03:11:50.332Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Gilgamesh を使って UI コンポーネントを拡張してみる">
<meta name="twitter:description" content="UI をコンポーネント・ベースで開発していると、コンポーネントを開発した当初は予期していなかったカスタマイズが必要になることがあります。何でもカスタマイズできるような汎用性を持たせられれば、それが一番良いですが、過剰な汎用性はアプリケーションを不必要に重くするだけです。 しかし、アプリケーション固有の UI コンポーネントをある程度の大きさの粒度で作っている場合、必要十分な汎用性を予測することは非">
<meta name="twitter:image" content="https://ygoto3.com/images/try-gilgamesh/postForm.png">
<meta name="twitter:creator" content="@ygoto3_">
<meta property="fb:app_id" content="777030512429159"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css"><link rel="stylesheet" href="/css/index.css"></head><body class="container"><div id="fb-root"></div><script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5&appId=777030512429159";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script><div class="container-introduction"><a href="/"><h1 class="site-title">ygoto3.com</h1></a></div><div class="container-posts"><article class="post"><header><h1 class="post__title">Gilgamesh を使って UI コンポーネントを拡張してみる</h1></header><div class="post__date">February 23, 2015</div><div class="post__entry"><p>UI をコンポーネント・ベースで開発していると、コンポーネントを開発した当初は予期していなかったカスタマイズが必要になることがあります。何でもカスタマイズできるような汎用性を持たせられれば、それが一番良いですが、過剰な汎用性はアプリケーションを不必要に重くするだけです。</p>
<p>しかし、アプリケーション固有の UI コンポーネントをある程度の大きさの粒度で作っている場合、必要十分な汎用性を予測することは非常に難しいことが多いため、必要になった時点で機能的な分岐を追加することが多いです。多くの場合、既存でそのコンポーネントを使っている箇所に影響を与えないように、分岐するためのフラグを要素の属性値として渡します。</p>
<p>ある程度の大きさの粒度というのは、例えば投稿フォームのような複数の input 、button 要素をテンプレートの中に持ち、バリデーションや Ajax などの機能を提供するくらいの粒度を想定しています。例えば、この投稿機能を提供する UI を下記のように使っている場合、</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">post-form</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p><a href="/images/try-gilgamesh/postForm.png"><img src="/images/try-gilgamesh/postForm.png" alt="postForm コンポーネント"></a></p>
<p><code>label</code> という属性の値として変更したいラベルのテキストを渡すことで、属性値が設定されていた場合だけデフォルトとは違うラベルに変更できるようにします。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">post-form</span> <span class="attr">label</span>=<span class="string">"まずは試してみる"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p><a href="/images/try-gilgamesh/SampleLabel.png"><img src="/images/try-gilgamesh/SampleLabel.png" alt="ラベルを変更した postFomr コンポーネント"></a></p>
<p>ただし、変更が必要になったときにこれを繰り返し続けると、次のようなことにもなりかねません。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">post-form</span></span></div><div class="line"><span class="tag">  <span class="attr">label</span>=<span class="string">"最初の投稿"</span></span></div><div class="line"><span class="tag">  <span class="attr">size</span>=<span class="string">"small"</span></span></div><div class="line"><span class="tag">  <span class="attr">skin</span>=<span class="string">"dark"</span></span></div><div class="line"><span class="tag">  <span class="attr">is-followed</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">  <span class="attr">stars</span>=<span class="string">"12"</span></span></div><div class="line"><span class="tag">  <span class="attr">limit</span>=<span class="string">"1000"</span></span></div><div class="line"><span class="tag">  …</span></div><div class="line"><span class="tag">  …</span></div><div class="line"><span class="tag">/&gt;</span></div></pre></td></tr></table></figure></p>
<p>さすがにこの例のような場合はデザイン的にも問題があるとは思いますが、運用を長く続けていると起こり得る自体です。</p>
<h3>Gilgamesh</h3>
<p><a href="http://sskyy.github.io/Gilgamesh/" title="Gilgamesh" target="_blank" rel="external">Gilgamesh</a> は、<a href="https://github.com/sskyy" title="sskyy (Zhenyu Hou)" target="_blank" rel="external">Zhenyu Hou</a> 氏が開発している JavaScript フレームワークを拡張するライブラリ集です。</p>
<p>JavaScript フレームワークを拡張する、とありますが、現在のところサポートしているフレームワークは、AngularJS のみです。今後 Polymer と React もサポートされる予定みたいです。</p>
<p>Gilgamesh には今のところ大きく２つの機能があります。</p>
<ol>
<li>テンプレート拡張ライブラリ</li>
<li>データソースライブラリ</li>
</ol>
<p>今回は、１つ目の「テンプレート拡張ライブラリ」としての機能を利用して AngularJS の <code>Directive</code> で作った UI コンポーネントの拡張を試してみます。</p>
<h3>Gilgamesh を試す準備</h3>
<p><a href="https://github.com/sskyy/Gilgamesh.git" title="sskyy/Gilgamesh" target="_blank" rel="external">Gilgamesh のリポジトリ</a> を clone してきて、任意の HTML で jQuery と AngularJS を読み込ませた上で下記の script 追加します。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./adapters/angular/adapter.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./build/Gilgamesh.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./adapters/angular/directives.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>ちなみに、jQuery を外して実行してみたところ、エラーが出たので現状は jQuery に依存しているのかもしれません。（あまり深く追ってないです。）</p>
<h3>Gilgamesh でコンポーネントを作成する</h3>
<p>AngularJS の Directive 機能でコンポーネントを作るのとほぼ同様に、Gilgamesh のコンポーネントを作ることができます。Angular モジュール・オブジェクトの <code>directive</code> メソッドを <code>component</code> に置き替えるだけです。</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'demo'</span>)</div><div class="line">.component(<span class="string">'postForm'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    templateUrl: <span class="string">'./template.html'</span>,</div><div class="line">    link: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>これで下記のように <code>&amp;lt;div post-form&amp;gt;&amp;lt;/div&amp;gt;</code> をマークアップに配置するとこのコンポーネントを使うことができます。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">post-form</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><a href="/images/try-gilgamesh/postForm.png"><img src="/images/try-gilgamesh/postForm.png" alt="postForm コンポーネント"></a></p>
<p>本当は、<code>restrict: 'E'</code> で、Element Derective にしたかったのですが、現時点では <code>&amp;lt;div post-form&amp;gt;&amp;lt;/div&amp;gt;</code> を配置するとエラーが出てうまく動作しませんでした。</p>
<h3>コンポーネントのパーツを書き替える</h3>
<p>Gilgamesh で作ったコンポーネントに対して、マークアップ側から変更を加えていきます。中止ボタンだけ別の見た目のボタンに変更します。</p>
<p>まず、コンポーネントで使っているテンプレートの中止ボタン要素に役割名を指定します。ここでは <code>cancel</code> という名前を指定します。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-xs-2"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-block"</span> <span class="attr">ng-click</span>=<span class="string">“user.cancel()</span>"</span></div><div class="line"><span class="tag">   <span class="attr">gm-role</span>=<span class="string">"cancel"</span></span></div><div class="line"><span class="tag">  &gt;</span>中止<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>次にコンポーネントを使用する側で、中止ボタンだけ置き替えたい要素に上書きする記述をします。コンポーネントの要素に <code>gm-tpl-partial</code> という属性を書き加えて、子要素として <code>gm-role=&quot;cancel&quot;</code> という属性を付けた要素を記述します。これが中止ボタンを上書きする要素になります。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">post-form</span> <span class="attr">gm-tpl-partial</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-block"</span> <span class="attr">ng-click</span>=<span class="string">“user.cancel()</span>"</span></div><div class="line"><span class="tag">   <span class="attr">gm-role</span>=<span class="string">"cancel"</span></span></div><div class="line"><span class="tag">  &gt;</span>解除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><a href="/images/try-gilgamesh/postFormPartial.png"><img src="/images/try-gilgamesh/postFormPartial.png" alt="部分的にパーツを上書きした postForm コンポーネント"></a></p>
<p>また、部分的にではなく、テンプレート自体を全体的に別のものにしたい場合は、<code>gm-tpl-partial</code> 属性を設定しないで、下記のようにコンポーネント要素の中身を上書きするだけで UI 全体が上書きされます。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">post-form</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- ここの記述でテンプレートをそっくり書き替える --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3>コンポーネントのパーツを取り除く</h3>
<p>部分的に上書きもできれば、部分的に取り除くこともできます。今度は中止ボタンをコンポーネントから取り除きます。<code>gm-tpl-exclude=&quot;cancel&quot;</code> という属性をコンポーネントの要素に追加するとテンプレートで <code>gm-role=&quot;cancel&quot;</code> 属性を与えられた要素だけ除外されます。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">post-form</span></span></div><div class="line"><span class="tag"> <span class="attr">gm-tpl-exclude</span>=<span class="string">"cancel"</span></span></div><div class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><a href="/images/try-gilgamesh/postFormExclude.png"><img src="/images/try-gilgamesh/postFormExclude.png" alt="postForm からパーツだけ除外"></a></p>
<h3>コンポーネントの外にある要素をコンポーネントのパーツとして扱う</h3>
<p>例えば、中止ボタンをテンプレートのマークアップ外に配置したい場合は、Gilgamesh のコンポーネントの外にある要素をコンポーネントのパーツとして扱うことができる機能が有効です。まずコンポーネントの要素に <code>id</code> を設定します。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">post-form</span> <span class="attr">id</span>=<span class="string">"postForm"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>そして HTML の任意の場所に中止ボタンとして機能させたい要素を <code>gm-import=&quot;postForm&quot;</code> 属性を加えて配置します。属性値を、先程の id 属性の値と同じにすることで、postForm コンポーネントの外にある要素をコンポーネントの中のものとして扱うことができるようになります。</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-block"</span></span></div><div class="line"><span class="tag"> <span class="attr">gm-import</span>=<span class="string">"postForm"</span></span></div><div class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">post-form</span> <span class="attr">id</span>=<span class="string">“postForm”</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>コンポーネントの外にあっても、<code>gm-import</code> 属性で紐付けられた要素内は postForm コンポーネントの scope に紐付きます。なので、要素内に書いた Angular 式は postForm のコンテキストで展開されます。</p>
<p><a href="/images/try-gilgamesh/postFormImport.png"><img src="/images/try-gilgamesh/postFormImport.png" alt="postForm コンポーネントに外部から要素を追加"></a></p>
<h3>コンポーネントを拡張する</h3>
<p>あるコンポーネントの <code>link</code> に設定した機能を継承して別のコンポーネントを作ることができます。<code>component</code> メソッドで新しいコンポーネントを作るときに <code>extend</code> キーを追加します。値には継承したい親コンポーネントの名前を指定します。</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'demo'</span>)</div><div class="line">.component(<span class="string">'postFormSubscribe'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    extend: <span class="string">'postForm'</span>,</div><div class="line">    templateUrl: <span class="string">'./template.html'</span>,</div><div class="line">    link: <span class="function"><span class="keyword">function</span> (<span class="params">iScope</span>) </span>&#123;</div><div class="line">      <span class="comment">// postForm の link が先に実行される</span></div><div class="line">      iScope.user.subscription = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>これで postForm コンポーネントを継承して追加で <code>iScope.user.subscription = true;</code> という処理を postFormSubscribe コンポーネントにだけ実行できます。<code>iScope.user.subscription = true;</code> を実行したことにより、postFormSubscribe コンポーネントでは、購読チェックボックスがデフォルトでオンになるようにしました。</p>
<p><a href="/images/try-gilgamesh/postFormExtend.png"><img src="/images/try-gilgamesh/postFormExtend.png" alt="postForm コンポーネントを拡張して作った postFormSubscribe コンポーネント"></a></p>
<p>この拡張機能は残念ながら、現時点で自分が試した範囲では <code>link</code> を継承することしかできないようでした。親のテンプレートを継承できるともっと使い道が広がりそうです。</p>
<h3>まだプロダクトでは使えなさそうだが...</h3>
<p>Gilgamesh のテンプレート拡張機能を試してみました。少しまだバグが多い印象なのでプロダクトにはまだ導入できないと思っています。しかし、予期できなかったけれど、必要になった汎用性を復活してくれるライブラリとして、機会があれば使ってみたいと思っています。</p>
<p>また本記事の内容については、<a href="http://www.slideshare.net/ygoto3q/componentization-with-gilgamesh" title="Componentization with Gilgamesh" target="_blank" rel="external">こちらのスライド</a>でも同様の内容を話しています。</p>
<p><strong>Gilgamesh</strong>
<a href="http://sskyy.github.io/Gilgamesh/" title="grunt-angular-templates" target="_blank" rel="external">http://sskyy.github.io/Gilgamesh/</a></p>
<p><strong>Gilgamesh: bring Angular to the next level</strong>
<a href="http://www.reddit.com/r/programming/comments/2s5exu/gilgamesh_bring_angular_to_the_next_level/" title="grunt-angular-templates" target="_blank" rel="external">http://www.reddit.com/r/programming/comments/2s5exu/gilgamesh_bring_angular_to_the_next_level/</a></p>
</div><div class="post__share"><a href="https://twitter.com/share" data-text="Gilgamesh を使って UI コンポーネントを拡張してみる" data-url="https://ygoto3.com/posts/try-gilgamesh/" data-via="ygoto3_" class="twitter-share-button">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script><div data-href="https://ygoto3.com/posts/try-gilgamesh/" data-layout="button" class="fb-share-button"></div></div></article></div><footer class="pure-u-1"><div class="container-footer"><div class="footer"><div class="pure-g"><div class="pure-u"><img src="/images/ygoto3-avatar.jpg" width="80" height="80" class="footer__avatar"/></div><div class="pure-u-3-4"><a href="/"><h2 class="site-title">ygoto3.com</h2></a><p class="copyright footer__copyright">&copy; 2016&nbsp;Yusuke Goto<a href="https://twitter.com/ygoto3_" class="copyright__icon"><i class="fa fa-lg fa-twitter-square"></i></a><a href="/atom.xml" class="copyright__icon"><i class="fa fa-lg fa-rss-square"></i></a></p></div></div></div></div></footer><script src="/js/app.js"></script></body></html>