<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="description" content="Software engineer at CyberAgent."><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ygoto3.com</title><meta name="description" content="Software engineer at CyberAgent.">
<meta property="og:type" content="website">
<meta property="og:title" content="ygoto3.com">
<meta property="og:url" content="https://ygoto3.com/tags/RTMP-ActionScript/index.html">
<meta property="og:site_name" content="ygoto3.com">
<meta property="og:description" content="Software engineer at CyberAgent.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ygoto3.com">
<meta name="twitter:description" content="Software engineer at CyberAgent.">
<meta name="twitter:creator" content="@ygoto3_">
<meta property="fb:app_id" content="777030512429159"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css"><link rel="stylesheet" href="/css/index.css"></head><body class="container"><div id="fb-root"></div><script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5&appId=777030512429159";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script><div class="pure-g"><header class="pure-u-1"><div class="container-introduction"><div class="introduction"><a href="/"><h1 class="site-title">ygoto3.com</h1></a><p class="introduction__text">Software engineer at CyberAgent.<a href="https://twitter.com/ygoto3_" class="introduction__twitter"><i class="fa fa-lg fa-twitter-square"></i></a></p></div></div></header><div class="pure-u-1"><div class="container-posts"><article class="post"><header><a href="/posts/live-streaming-and-rtmp-for-frontend-engineers/" class="post__title"><h2>フロントエンドエンジニアのための生放送と RTMP 通信基礎</h2></a></header><div class="post__date">October 11, 2016</div><div class="post__entry"><p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/obs-sc.png" alt="生放送と RTMP 通信基礎"></p>
<p>前回「<a href="/posts/streaming-technology-basics-for-frontend-engineers/">フロントエンドエンジニアのための動画ストリーミング技術基礎</a>」では HTTP ベースのストリーミング技術に関して勉強会を実施しました。視聴者に映像を届けるためのストリーミング技術に関してのお話でした。</p>
<p>本記事は、<a href="https://abema.tv/" target="_blank" rel="external">AbemaTV</a> の生放送番組で撮影機材から送られた映像がエンコーダーを介してリアルタイムに放送する部分について勉強会を実施した際の資料です。</p>
<h2>生放送における動画データの通信</h2>
<p>AbemaTV では生放送で撮影した動画データのやりとりに <strong>RTMP</strong> というプロトコルを利用しています。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/live-streaming.png" alt="生放送の配信構成"></p>
<h2>RTMP とは</h2>
<p>RTMP は <strong>Real-Time Message Protocol</strong> の略で、その名前の通りリアルタイムにコミュニケーションを行うためのプロトコルです。Web 業界では Photoshop などでお馴染の <a href="http://www.adobe.com/" target="_blank" rel="external">Adobe Systems</a> 社が開発しています。<a href="http://www.adobe.com/software/flash/about/" target="_blank" rel="external">Adobe Flash Player</a> がメディア配信サーバーとの間で音声や動画などのデータをやりとりするためのストリーミングのためのプロトコルとして開発されました。</p>
<p><a href="/posts/streaming-technology-basics-for-frontend-engineers/">前回</a>紹介した HLS や MPEG-DASH もストリーミングプロトコルでしたが、RTMP はこれらと異なり、<strong>HTTP ベースではありません</strong>。ですので、HLS や MPEG-DASH のように通常の Web サーバーでコンテンツを配信できるわけではなく、専用の RTMP サーバーが必要になります。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/http-and-rtmp.png" alt="RTMP 専用サーバー"></p>
<h2>HTTP に対する優位性</h2>
<p>HTTP における通信は必ずクライアントのリクエストから始まります。そのため、動画をストリーミングしようとする際、クライアントはサーバーに対して任意のインターバルで動画のセグメントをリクエストし続ける必要があります。HLS や MPEG-DASH におけるストリーミングはこの方式ですが、クライアントのタイミングで動画データをリクエストするため、本当の意味でのリアルタイム性はありません。動画データを生成しているサーバー側が送信したいタイミングでクライアントにデータをプッシュできる方が遅延が発生することがなく、効率的です。</p>
<p>それに対して、RTMP におけるデータ通信は持続的に接続した状態で双方向に行われます。そのため、サーバーがクライアントに送信したいタイミングでプッシュ送信することができ、遅延が発生しません。</p>
<p>また HTTP の場合、HTTP レスポンスヘッダーは冗長で一般的に数百バイトになります。返したいペイロードサイズに対してのオーバーヘッドを大きくしてしまっています。それに対し、RTMP パケットのヘッダーは固定長で 12 / 8 / 4 / 1 バイトのうちどれかになり、ペイロードサイズに対するオーバーヘッドは小さいです。</p>
<h2>生放送の現場ではリアルタイム性を重視</h2>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/live-streaming-wirecast.png" alt="生放送の配信構成"></p>
<p>AbemaTV の生放送の現場では撮影機材で撮れた映像を Wirecast などのエンコーダーでエンコードし、それを RTMP 通信で Wowza などのメディアストリーミングサーバーに届けています。そして、メディアストリーミングサーバーに届けられた映像を確認しながら、生で撮影しているその映像に対して遅延を極力少ない状態で CM 入りや視聴者参加型コンテンツなどのトリガーとなるシグナルを通信できる環境を構築しています。</p>
<h2>RTMP の種類</h2>
<p>RTMP にはいくつかの派生種があります。</p>
<ul>
<li><strong>RTMPT</strong> - HTTP でカプセル化した RTMP</li>
<li><strong>RTMPS</strong> - TLS/SSL で暗号化して HTTPS でカプセル化した RTMP</li>
<li><strong>RTMPE</strong> - こちらも暗号化された RTMP ですが、設計に欠陥があり RTMPS の使用が推奨されている</li>
<li><strong>pRTMP</strong> - Adobe Primetime DRM がかかった RTMP</li>
</ul>
<p>RTMP は一般的に <code>1935</code> ポートを使用します。しかし、セキュリティの厳しい環境ではこの <code>1935</code> ポートが使えないこともしばしばあります。そのため、HTTP（ <code>80</code> ポート）や HTTPS（ <code>443</code> ポート）を装って通信するという手段を取ることが可能です。それが <strong>RTMPT</strong> と <strong>RTMPS</strong> になります。</p>
<h2>更にリアルタイム性を重視したデータ通信</h2>
<p>RTMP は <strong>TCP</strong> を利用したプロトコルですが、別に <strong>RTMFP</strong> という <strong>UDP</strong> を利用したプロトコルもあります。UDP を利用するプロトコルは TCP を利用するプロトコルと比べて通信速度面において利点があります。TCP はパケット・ロストに対して再送する仕組みですが、UDP はパケット・ロストに対して再送することはありません。その分再送のオーバーヘッドなく通信することができます。</p>
<h2>データ量の大きな双方向データ通信</h2>
<p>RTMP は双方向のデータ通信が可能なプロトコルですが、両方向とも送信するデータ量が大きな通信サービスを構築する場合は UDP ベースの RTMFP が好まれます。たとえばテレビ会議やビデオチャットなどは双方が送信するデータが動画のため、データサイズが大きいにも関わらず、スムーズなコミュニケーションのためにリアルタイム性が求められます。</p>
<p>TCP で パケット・ロストによる再送で遅延の頻度が高まると、音声や映像が遅れた状態になる可能性が高くなります。特にテレビ会議やビデオチャットなどはデータの抜け落ちが発生したとしてもノイズ程度の劣化として許容できる場合がほとんどなため、UDP での通信が向いています。</p>
<h2>RTMP をサポートするメディアストリーミングサーバ</h2>
<p>RTMP でストリーミング配信するには、専用の RTMP サーバーが必要です。ここでは RTMP をサポートする代表的なメディアストリーミングサーバーを３つ紹介します。</p>
<h3>Adobe Media Server</h3>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/adobe-media-server.png" alt="Adobe Media Server"></p>
<p>Adobe Systems 社が開発しているメディアストリーミングサーバーです。Flash 技術の総本山である Adobe が開発しているだけあり、ここで紹介するメディアサーバーの中で一番知名度が高く、機能も豊富です。そしてその分ライセンス料も高いです。（RTMFP のサポート有無など機能数に応じて複数のエディションに別れています。）</p>
<p>参照：<a href="http://www.adobe.com/jp/products/adobe-media-server-family/buying-guide-comparison.html" target="_blank" rel="external">Adobe Media Serverファミリー</a></p>
<h3>Wowza Media Server</h3>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/wowza.png" alt="Wowza Media Systems"></p>
<p><a href="https://www.wowza.com/" target="_blank" rel="external">Wowza Media Systems</a> 社によって開発されているメディアストリーミングサーバーです。元 Adobe Systems の社員がスピンアウトして立ち上げたこともあり、Adobe Media Server との互換性が高く、ほぼ同等の機能を持っています。それにも関わらずライセンス価格は Adobe Media Server と比較するとかなり安価なこともあり、AbemaTV でも生放送のストリーミングサーバーには Wowza Media Server を使用しています。</p>
<h3>Red5</h3>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/red5.png" alt="Red5"></p>
<p>Java で実装されたオープンソースの RTMP プロトコルをサポートするメディアストリーミングサーバーです。Adobe Media Server にかなり似せて作られていて、単体のサーバーとしては同等の機能を提供してくれますが、クラスタリング構成にあまり対応していないため、大規模な配信サービスを構築する場合には注意が必要です。</p>
<h2>RTMP を使用するためのクライアントサイド</h2>
<p>Web ブラウザは RTMP をネイティブでは対応していません。ブラウザ上で RTMP を使用するためには、プラグインとして Adobe Flash Player を使用する必要があります。</p>
<h2>簡単な RTMP ストリーミング配信を実装してみる</h2>
<p>まずは RTMP ストリーミングサーバーを構築します。先述したメディアサーバーを使用したいところですが、今回は単純なストリーミング機能のみを提供できれば良いので、NGINX をメディアストリーミングサーバーとして使うことができる <a href="https://github.com/arut/nginx-rtmp-module" target="_blank" rel="external">nginx-rtmp-module</a> を使います。</p>
<h3>Docker で NGINX を立てる</h3>
<p>nginx-rtmp-module を追加してコンパイルした NGINX の Docker イメージを作ります。ベースイメージには Alpine Linux を使います。ここでは RTMP 用に <code>1935</code> ポートと Flash アプリケーションを読み込むための HTML を返すために HTTP <code>80</code> ポートを開けるようにします。</p>
<h4>Dockerfile を作成する</h4>
<p>下記の Dockerfile では、コンパイルに必要なパッケージを <code>apk</code> でインストールして、任意のバージョンの NGINX と nginx-rtmp-module の Tarball をダウンロードし、コンパイルしています。 <code>./configure</code> のパラメータがやたら多いですが、必要ないモジュールを除外しているだけです。</p>
<p><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">FROM alpine:3.4</div><div class="line">ENV NGINX_VERSION nginx-1.11.4</div><div class="line">ENV NGINX_RTMP_MODULE_VERSION 1.1.7.10</div><div class="line"></div><div class="line">ENV USER nginx</div><div class="line">RUN adduser -s /sbin/nologin -D -H $&#123;USER&#125;</div><div class="line"></div><div class="line">RUN apk --update --no-cache \</div><div class="line">    add ca-certificates \</div><div class="line">        build-base \</div><div class="line">        openssl \</div><div class="line">        openssl-dev \</div><div class="line">        pcre-dev \</div><div class="line">    &amp;&amp; \</div><div class="line">    update-ca-certificates &amp;&amp; \</div><div class="line">    rm -rf /var/cache/apk/*</div><div class="line"></div><div class="line">RUN mkdir -p /tmp/build/nginx &amp;&amp; \</div><div class="line">    cd /tmp/build/nginx &amp;&amp; \</div><div class="line">    wget -O $&#123;NGINX_VERSION&#125;.tar.gz https://nginx.org/download/$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \</div><div class="line">    tar -zxf $&#123;NGINX_VERSION&#125;.tar.gz</div><div class="line"></div><div class="line">RUN mkdir -p /tmp/build/nginx-rtmp-module &amp;&amp; \</div><div class="line">    cd /tmp/build/nginx-rtmp-module &amp;&amp; \</div><div class="line">    wget -O nginx-rtmp-module-$&#123;NGINX_RTMP_MODULE_VERSION&#125;.tar.gz https://github.com/sergey-dryabzhinsky/nginx-rtmp-module/archive/v$&#123;NGINX_RTMP_MODULE_VERSION&#125;.tar.gz &amp;&amp; \</div><div class="line">    tar -zxf nginx-rtmp-module-$&#123;NGINX_RTMP_MODULE_VERSION&#125;.tar.gz &amp;&amp; \</div><div class="line">    cd nginx-rtmp-module-$&#123;NGINX_RTMP_MODULE_VERSION&#125; &amp;&amp; \</div><div class="line">    wget -O - https://raw.githubusercontent.com/gentoo/gentoo/6241ba18ca4a5e043a97ad11cf450c8d27b3079f/www-servers/nginx/files/rtmp-nginx-1.11.0.patch | patch</div><div class="line"></div><div class="line">RUN cd /tmp/build/nginx/$&#123;NGINX_VERSION&#125; &amp;&amp; \</div><div class="line">    ./configure \</div><div class="line">      -<span class="ruby">-sbin-path=<span class="regexp">/usr/local</span><span class="regexp">/sbin/nginx</span> \</span></div><div class="line"><span class="ruby">      --conf-path=<span class="regexp">/etc/nginx</span><span class="regexp">/nginx.conf \</span></span></div><div class="line"><span class="ruby">      --error-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/error</span>.log \</span></div><div class="line"><span class="ruby">      --pid-path=<span class="regexp">/var/run</span><span class="regexp">/nginx/nginx</span>.pid \</span></div><div class="line"><span class="ruby">      --lock-path=<span class="regexp">/var/lock</span><span class="regexp">/nginx/nginx</span>.lock \</span></div><div class="line"><span class="ruby">      --user=$&#123;USER&#125; --group=$&#123;USER&#125; \</span></div><div class="line"><span class="ruby">      --http-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/access</span>.log \</span></div><div class="line"><span class="ruby">      --http-client-body-temp-path=<span class="regexp">/tmp/nginx</span>-client-body \</span></div><div class="line"><span class="ruby">      --with-http_ssl_module \</span></div><div class="line"><span class="ruby">      --with-http_gzip_static_module \</span></div><div class="line"><span class="ruby">      --without-http_userid_module \</span></div><div class="line"><span class="ruby">      --without-http_access_module \</span></div><div class="line"><span class="ruby">      --without-http_auth_basic_module \</span></div><div class="line"><span class="ruby">      --without-http_autoindex_module \</span></div><div class="line"><span class="ruby">      --without-http_geo_module \</span></div><div class="line"><span class="ruby">      --without-http_map_module \</span></div><div class="line"><span class="ruby">      --without-http_split_clients_module \</span></div><div class="line"><span class="ruby">      --without-http_referer_module \</span></div><div class="line"><span class="ruby">      --without-http_proxy_module \</span></div><div class="line"><span class="ruby">      --without-http_fastcgi_module \</span></div><div class="line"><span class="ruby">      --without-http_uwsgi_module \</span></div><div class="line"><span class="ruby">      --without-http_scgi_module \</span></div><div class="line"><span class="ruby">      --without-http_memcached_module \</span></div><div class="line"><span class="ruby">      --without-http_limit_conn_module \</span></div><div class="line"><span class="ruby">      --without-http_limit_req_module \</span></div><div class="line"><span class="ruby">      --without-http_empty_gif_module \</span></div><div class="line"><span class="ruby">      --without-http_browser_module \</span></div><div class="line"><span class="ruby">      --without-http_upstream_hash_module \</span></div><div class="line"><span class="ruby">      --without-http_upstream_ip_hash_module \</span></div><div class="line"><span class="ruby">      --without-http_upstream_least_conn_module \</span></div><div class="line"><span class="ruby">      --without-http_upstream_keepalive_module \</span></div><div class="line"><span class="ruby">      --without-http_upstream_zone_module \</span></div><div class="line"><span class="ruby">      --without-http-cache \</span></div><div class="line"><span class="ruby">      --without-mail_pop3_module \</span></div><div class="line"><span class="ruby">      --without-mail_imap_module \</span></div><div class="line"><span class="ruby">      --without-mail_smtp_module \</span></div><div class="line"><span class="ruby">      --without-stream_limit_conn_module \</span></div><div class="line"><span class="ruby">      --without-stream_access_module \</span></div><div class="line"><span class="ruby">      --without-stream_upstream_hash_module \</span></div><div class="line"><span class="ruby">      --without-stream_upstream_least_conn_module \</span></div><div class="line"><span class="ruby">      --without-stream_upstream_zone_module \</span></div><div class="line"><span class="ruby">      --with-threads \</span></div><div class="line"><span class="ruby">      --with-ipv6 \</span></div><div class="line"><span class="ruby">      --add-<span class="class"><span class="keyword">module</span>=/<span class="title">tmp</span>/<span class="title">build</span>/<span class="title">nginx</span>-<span class="title">rtmp</span>-<span class="title">module</span>/<span class="title">nginx</span>-<span class="title">rtmp</span>-<span class="title">module</span>-$&#123;<span class="title">NGINX_RTMP_MODULE_VERSION</span>&#125; &amp;&amp; \</span></span></div><div class="line"><span class="ruby">    make -j $(getconf _NPROCESSORS_ONLN) &amp;&amp; \</span></div><div class="line"><span class="ruby">    make install &amp;&amp; \</span></div><div class="line"><span class="ruby">    mkdir /var/lock/nginx &amp;&amp; \</span></div><div class="line"><span class="ruby">    mkdir /tmp/nginx-client-body &amp;&amp; \</span></div><div class="line"><span class="ruby">    rm -rf /tmp/build</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">RUN apk del build-base openssl-dev &amp;&amp; \</span></div><div class="line"><span class="ruby">    rm -rf /var/cache/apk/*</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">RUN ln -sf /dev/stdout /var/log/nginx/access.log &amp;&amp; \</span></div><div class="line"><span class="ruby">    ln -sf /dev/stderr /var/log/nginx/error.log</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">COPY nginx/nginx.conf /etc/nginx/nginx.conf</span></div><div class="line"><span class="ruby">COPY build /var/www/build</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">RUN chmod <span class="number">444</span> /etc/nginx/nginx.conf &amp;&amp; \</span></div><div class="line"><span class="ruby">    chown $&#123;USER&#125;<span class="symbol">:</span>$&#123;USER&#125; /var/log/nginx /var/run/nginx /var/lock/nginx /tmp/nginx-client-body &amp;&amp; \</span></div><div class="line"><span class="ruby">    chmod -R <span class="number">770</span> /var/log/nginx /var/run/nginx /var/lock/nginx /tmp/nginx-client-body</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">EXPOSE <span class="number">80</span></span></div><div class="line"><span class="ruby">EXPOSE <span class="number">1935</span></span></div><div class="line"><span class="ruby">CMD [<span class="string">"nginx"</span>]</span></div></pre></td></tr></table></figure></p>
<h4>NGINX の configuration を設定する</h4>
<p>イメージにコピーする <code>nginx.conf</code> は下記のように設定します。 <code>http</code> コンテキストに加えて <code>nginx-rtmp-module</code> で使用できるようになった <code>rtmp</code> コンテキストに設定を追加しています。</p>
<p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">user nginx;</div><div class="line">worker_processes 1;</div><div class="line">daemon off;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">  <span class="built_in">..</span>.</div><div class="line">&#125;</div><div class="line"></div><div class="line">http &#123;</div><div class="line">  <span class="built_in">..</span>.</div><div class="line">&#125;</div><div class="line"></div><div class="line">rtmp &#123;</div><div class="line"> <span class="built_in"> server </span>&#123;</div><div class="line">    listen 1935;</div><div class="line">    listen [::]:1935 <span class="attribute">ipv6only</span>=on;</div><div class="line"></div><div class="line">    application live &#123;</div><div class="line">      live on;</div><div class="line">      record off;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>この <code>rtmp</code> コンテキストの設定により、ローカルに Docker コンテナを立ち上げたとき <code>rtmp://localhost:1935/live</code> という URL で RTMP サーバに接続が可能になります。</p>
<h3>RTMP プレイヤーを実装する</h3>
<p>次に RTMP プレイヤーとそれを表示する HTML を作成します。RTMP プレイヤーは Flash アプリケーションとして実装するので ActionScript で書きます。まず新規ファイル <code>Player.as</code> を作成します。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ touch Player.as</div></pre></td></tr></table></figure></p>
<p><code>Player.as</code> に <code>Player</code> クラスを作成します。動画を表示するための <code>Video</code> オブジェクトも追加したいので、 <code>Sprite</code> クラスを継承しておきます。</p>
<p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">package</span> &#123;</span></div><div class="line"></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.display.Sprite;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.display.StageScaleMode;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.display.StageAlign;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.events.Event;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.events.NetStatusEvent;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.net.NetConnection;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.net.NetStream;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.media.Video;</span></div><div class="line">  <span class="meta"><span class="meta-keyword">import</span> flash.external.ExternalInterface;</span></div><div class="line"></div><div class="line">  [SWF(backgroundColor=<span class="string">"0x000000"</span>)]</div><div class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">Sprite</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">var</span> nc: NetConnection;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">var</span> ns: NetStream;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">var</span> video: Video;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Player</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>次に <code>Stage</code> の設定します。Flash コンテンツを左上に整列する設定だけします。</p>
<p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span><span class="params">()</span> </span>&#123;</div><div class="line">  setupStage();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setupStage</span><span class="params">()</span>: void </span>&#123;</div><div class="line">  stage.scaleMode = StageScaleMode.NO_SCALE;</div><div class="line">  stage.align = StageAlign.TOP_LEFT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>NetConnection</code> クラスを使い、クライアントとサーバー間の双方向の接続を作成するための準備をします。 <code>NetConnection</code> オブジェクトのステータスが変化したタイミングで、メディアサーバーからのデータを再生できるように、 <code>NetStream</code> クラスを使ってストリームチャネルを開きます。開いた後ライブストリームを再生するために <code>ns.play()</code> メソッドを実行します。このときストリーム名として <code>&quot;test&quot;</code> を渡していますが、これは後程ライブストリームを作成する際にも使う名前になります。</p>
<p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span><span class="params">()</span> </span>&#123;</div><div class="line">  ...</div><div class="line">  setupNetConnection();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setupNetConnection</span><span class="params">()</span>: void </span>&#123;</div><div class="line">  nc = <span class="keyword">new</span> NetConnection();</div><div class="line">  nc.addEventListener(NetStatusEvent.NET_STATUS, onChangeNCStatus);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">onChangeNCStatus</span><span class="params">(e: NetStatusEvent)</span>: void </span>&#123;</div><div class="line">  <span class="keyword">const</span> code: String = e.info.code;</div><div class="line">  <span class="keyword">if</span> (code === <span class="string">"NetConnection.Connect.Success"</span>) &#123;</div><div class="line">    setupNetStream();</div><div class="line">    ns.play(<span class="string">"test"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>作成したストリームチャネルからの動画を表示するために <code>Video</code> オブジェクトに取り付けます。</p>
<p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setupNetStream</span><span class="params">()</span>: void </span>&#123;</div><div class="line">  ns = <span class="keyword">new</span> NetStream(nc);</div><div class="line">  ns.addEventListener(NetStatusEvent.NET_STATUS, onChangeNSStatus);</div><div class="line"></div><div class="line">  video.attachNetStream(ns);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>この <code>Video</code> オブジェクトもコンストラクト時に作成し、ステージに追加してきます。</p>
<p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span><span class="params">()</span> </span>&#123;</div><div class="line">  ...</div><div class="line">  ssetupVideo();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setupVideo</span><span class="params">()</span>: void </span>&#123;</div><div class="line">  video = <span class="keyword">new</span> Video(stage.width, stage.height);</div><div class="line">  addChild(video);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>NetConnection</code> の準備が整ったので、最後にメディアサーバーに接続します。URL は先程の NGINX の RTMP メディアサーバーの <code>live</code> application に向けています。</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  ...</div><div class="line">  nc.connect(<span class="string">"rtmp://localhost:1935/live"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>ActionScript のコンパイル</h3>
<p>これで RTMP サーバーの実装はできたので、次は ActionScript をコンパイルします。コンパイルには Apache/Adobe Flex SDK の Node.js モジュール版である <a href="https://github.com/JamesMGreene/node-flex-sdk" target="_blank" rel="external">node-flex-sdk</a> を使用します。まずは NPM でインストールします。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm i flex-sdk --save-dev</div></pre></td></tr></table></figure></p>
<p>無事インストールできたら、<code>mxmlc</code> というコマンドを使って、 <code>Player.as</code> から <code>Player.swf</code> をコンパイルします。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ $(npm bin)/mxmlc --output=Player.swf Player.as</div></pre></td></tr></table></figure></p>
<h3>HTML の作成</h3>
<p>作成された <code>Player.swf</code> を表示する HTML を作成します。</p>
<p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">object</span> <span class="keyword">data</span>=<span class="string">"./Player.swf"</span> type=<span class="string">"application/x-shockwave-flash"</span>&gt;&lt;/<span class="keyword">object</span>&gt;</div></pre></td></tr></table></figure></p>
<h3>Docker コンテナの起動</h3>
<p>Docker コンテナの構成に必要なファイルが揃ったので、これでイメージを作成します。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker build -t rtmp .</div></pre></td></tr></table></figure></p>
<p>イメージが作成できたか確認しましょう。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ docker images</div><div class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">rtmp                         latest              ************        About a minute ago          180.7 MB</div></pre></td></tr></table></figure></p>
<p>無事に作成できたら、そのイメージから Docker コンテナを起動します。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run -p 1935:1935 -p 80:80 --name rtmp -t rtmp</div></pre></td></tr></table></figure></p>
<p>Web ブラウザで <a href="http://localhost/" target="_blank" rel="external">http://localhost/</a> にアクセスしてみましょう。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/browser-sc-black.png" alt="RTMP プレイヤー"></p>
<p>黒いボックスが表示されたと思います。このボックスが RTMP プレイヤーなのですが、今は配信するストリームが存在していないため、何も再生できず黒い状態です。ですので、次は再生するストリームを作成します。</p>
<h3>ストリームの作成</h3>
<p>ここでは、<a href="https://obsproject.com/" target="_blank" rel="external">Open Broadcaster Software</a> （OBS）というオープンソースのライブストリーミング用のツールを使用してストリームを作成します。</p>
<p>OBS を起動して、「Settings」ボタンをクリックします。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/obs-sc-settings.png" alt="OBS"></p>
<p>「Settings」ダイアログが表示されるので、左側のペインから「Stream」を選択します。
すると「URL」と「Stream key」を入力する画面に切り替わりますので、「URL」に NGINX の RTMP サーバーの <code>live</code> application の URL を入力し、「Stream key」には先程 RTMP プレイヤーを実装したときにストリーム名として指定した <code>test</code> を入力します。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/obs-sc-stream.png" alt="OBS Settings"></p>
<p>「Settings」ダイアログで「OK」をクリックしたら、次に「 Sources」の「+」をクリックして適当なメディアソースを追加します。プルダウンメニューが表示されるので「Media Source」を選択して任意の動画ファイルを追加します。</p>
<p>メディアソースが追加されたら、「Start Streaming」ボタンをクリックしてストリーミングを開始します。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/obs-sc-start.png" alt="OBS Sources"></p>
<p>ストリーミングが開始されたら、Web ブラウザに戻ります。すると OBS でストリームしている動画がブラウザの方でも再生されていることが確認できます。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/browser-sc.png" alt="RTMP 再生"></p>
<h2>RTMP でメディアサーバーのメソッドを呼ぶ</h2>
<p>ここまでで RTMP でサーバー側からプッシュされたデータをクライアントで再生する実装をしてきました。しかし、RTMP は双方向のデータ通信が可能なので、クライアント側からサーバー側のメソッドを呼ぶことも可能です。 <code>nginx-rtmp-module</code> では難しいですが、メディアサーバーに Adobe Media Server や Wowza Media Server を利用して開発をした場合、クライアント側からサーバー側のメソッドを呼ぶことが可能です。</p>
<p>ActionScript の場合、クライアントとサーバー間の双方向の接続が作成した後（ <code>NetConnection</code> オブジェクトが <code>nc.connect()</code> して、 <code>NetStatusEvent</code> が <code>&quot;NetConnection.Connect.Success&quot;</code> になった後）であれば、 <code>nc.call()</code> でサーバー側のメソッドを呼ぶことができます。 <code>nc.call()</code> の第１引数がメソッド名なので、 <code>nc.call(&quot;doSomething&quot;)</code> のようにクライアントから実行した場合、メディアサーバーに実装した該当のメソッドが実行されます。</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/call.png" alt="NetConnection.call"></p>
<p>たとえば Wowza Media Server の場合であれば、実装は Java なので下記のようなメソッドを実装することで、クライアントから Wowza Media Server のコンソールに <code>doSomething is called</code> と表示させることが可能です。</p>
<p><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span>(<span class="params">IClient client, RequestFunction function, AMFDataList <span class="keyword">params</span></span>) </span>&#123;  </div><div class="line">  getLogger().info(<span class="string">"doSomething is called"</span>);  </div><div class="line">  <span class="comment">// do something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbemaTV の生放送番組では、RTMP の双方向通信を利用して、Web ブラウザから Wowza Media Server のメソッドを呼ぶことで、番組の進行具合に合わせて CM 入りのタイミングや視聴者参加型のインタラクションコンテンツのトリガーを最小限の遅延で放送に挿し込んでいます。</p>
<h2>RTMP で受け取った動画を HLS でもストリーミング</h2>
<p>メディアサーバーはエンコーダーから RTMP 通信で送られた動画をそのまま RTMP でクライアントにプッシュ送信する以外に HLS や MPEG-DASH でストリーミングできるように変換することも可能です。たとえが nginx-rtmp-module の場合は先程作成した <code>nginx.conf</code> を編集して、 <code>application live</code> コンテキストに HLS に関する以下のディレクティブを追加します。</p>
<p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">application</span> live &#123;</div><div class="line">  <span class="attribute">live</span> <span class="literal">on</span>;</div><div class="line">  <span class="attribute">record</span> <span class="literal">off</span>;</div><div class="line"></div><div class="line">  <span class="attribute">hls</span> <span class="literal">on</span>;</div><div class="line">  <span class="attribute">hls_path</span> /usr/local/nginx/html/hls;</div><div class="line">  <span class="attribute">hls_fragment</span> <span class="number">1s</span>;</div><div class="line">  <span class="attribute">hls_type</span> live;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>すると、Live セッションの m3u8 プレイリストと 1 秒感覚のセグメントファイルを <code>/usr/local/nginx/html/hls/live</code> に出力してくれます。この <code>nginx.conf</code> を反映した Docker コンテナが起動している状態で、<a href="http://localhost/hls/test.m3u8" target="_blank" rel="external">http://localhost/hls/test.m3u8</a> に Safari でアクセスすると HLS でストリーミング再生ができます。（Safari でアクセスする理由は<a href="/posts/streaming-technology-basics-for-frontend-engineers/">前回</a>書いた通り、HLS をネイティブサポートしている Web ブラウザが Safari だけだからです。）</p>
<p><img src="/images/live-streaming-and-rtmp-for-frontend-engineers/safari-hls.png" alt="HLS を Safari で再生"></p>
<h2>まとめ</h2>
<p>普段の Web フロントエンドの開発では、RTMP や ActionScript を扱う必要があることはあまりありません。しかし、こと動画やストリーミング領域となるとまだ Flash テクノロジーの安定性にお世話になることも多いように思います。WebRTC や WebSocket などの技術の組み合わせでこのあたりの事情もどんどん変化していきそうです。</p>
<h2>参考</h2>
<ul>
<li>
<p><a href="http://joy2world.tistory.com/attachment/ek8.pdf" target="_blank" rel="external">RTMP Protocol [DRAFT]</a></p>
</li>
<li>
<p><a href="http://www.streamingmedia.com/Articles/Editorial/Featured-Articles/RTMP-in-the-Age-of-HTTP-Video-Streaming-Dont-Count-it-Out-100909.aspx" target="_blank" rel="external">RTMP in the Age of HTTP Video Streaming: Don't Count it Out</a></p>
</li>
<li>
<p><a href="http://www.programming-knowledge.com/Adobe_Media_Server%E6%A6%82%E8%A6%81" target="_blank" rel="external">Adobe Media Server概要</a></p>
</li>
<li>
<p><a href="http://www.itoyanagi.name/temp/fuck/d20071109.html" target="_blank" rel="external">各種 RTMP サーバーでのライブストリーミングの実現</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Red5_(media_server)" target="_blank" rel="external">Red5 (media server)</a></p>
</li>
<li>
<p><a href="https://gist.github.com/voluntas/076fee77f30a0ca7a9b9" target="_blank" rel="external">リアルタイム動画配信コトハジメ</a></p>
</li>
<li>
<p><a href="http://flashcafe.jp/kazari/k_m_clo/real.html" target="_blank" rel="external">RTMFPとRTMP</a></p>
</li>
<li>
<p><a href="https://ja.wikipedia.org/wiki/Real_Time_Media_Flow_Protocol" target="_blank" rel="external">Real Time Media Flow Protocol</a></p>
</li>
<li>
<p><a href="http://www.neotys.com/blog/testing-tips-for-todays-tech-html5-websockets-rtmp-adaptive-bitrate-streaming/" target="_blank" rel="external">Testing Tips For Today’s Tech: HTML5, WebSockets, RTMP, Adaptive Bitrate Streaming</a></p>
</li>
<li>
<p><a href="http://coelacanth.heteml.jp/site/flash_wowza/article_5" target="_blank" rel="external">5-1.クライアントからサーバーのメソッドを呼び出す</a></p>
</li>
<li>
<p><a href="https://github.com/DvdGiessen/nginx-rtmp-docker" target="_blank" rel="external">DvdGiessen/nginx-rtmp-docker</a></p>
</li>
<li>
<p><a href="http://www.slideshare.net/chintal75/building-next-generation-realtime-web-applications" target="_blank" rel="external">Building Next Generation Real-Time Web Applications using Websockets</a></p>
</li>
<li>
<p><a href="http://www.slideshare.net/mawarimichi/websocketwebrtc" target="_blank" rel="external">WebSocket / WebRTCの技術紹介</a></p>
</li>
</ul>
</div><div class="post__share"><a href="https://twitter.com/share" data-text="フロントエンドエンジニアのための生放送と RTMP 通信基礎" data-url="https://ygoto3.com/posts/live-streaming-and-rtmp-for-frontend-engineers/" data-via="ygoto3_" class="twitter-share-button">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script><div data-href="https://ygoto3.com/posts/live-streaming-and-rtmp-for-frontend-engineers/" data-layout="button" class="fb-share-button"></div></div></article><div class="container-paginator"></div></div></div></div><footer class="pure-u-1"><div class="container-footer"><div class="footer"><div class="pure-g"><div class="pure-u"><img src="/images/ygoto3-avatar.jpg" width="80" height="80" class="footer__avatar"/></div><div class="pure-u-3-4"><a href="/"><h2 class="site-title">ygoto3.com</h2></a><p class="copyright footer__copyright">&copy; 2016&nbsp;Yusuke Goto<a href="https://twitter.com/ygoto3_" class="copyright__icon"><i class="fa fa-lg fa-twitter-square"></i></a><a href="/atom.xml" class="copyright__icon"><i class="fa fa-lg fa-rss-square"></i></a></p></div></div></div></div></footer><script src="/js/app.js"></script></body></html>